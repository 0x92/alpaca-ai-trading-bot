<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Trading Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 p-4">
    {% block content %}{% endblock %}
    <script>
        const socket = io();
        const charts = {};

        function createChart(name, labels, values) {
            const ctx = document.getElementById('chart-' + name).getContext('2d');
            charts[name] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Equity',
                        data: values,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function updatePortfolios(data) {
            if (!Array.isArray(data)) return;
            data.forEach(p => {
                const el = document.getElementById('portfolio-' + p.name);
                if (!el) return;
                el.querySelector('.cash').textContent = p.cash;
                el.querySelector('.portfolio_value').textContent = p.portfolio_value;
                const historyList = el.querySelector('.history');
                historyList.innerHTML = '';
                if (p.history.length === 0) {
                    historyList.innerHTML = '<li>No trades yet.</li>';
                } else {
                    p.history.forEach(t => {
                        const item = document.createElement('li');
                        item.textContent = `${t.symbol} ${t.side} ${t.qty} @ ${t.submitted_at}`;
                        historyList.appendChild(item);
                    });
                }

                const labels = p.equity.map(e => e.time);
                const values = p.equity.map(e => e.value);
                if (!charts[p.name]) {
                    createChart(p.name, labels, values);
                } else {
                    charts[p.name].data.labels = labels;
                    charts[p.name].data.datasets[0].data = values;
                    charts[p.name].update();
                }
            });
        }

        socket.on('trade_update', updatePortfolios);
        // initial bootstrap from server rendered data
        document.addEventListener('DOMContentLoaded', () => {
            const dataElement = document.getElementById('initial-data');
            if (dataElement) {
                const portfolios = JSON.parse(dataElement.textContent);
                updatePortfolios(portfolios);
            }
        });
    </script>
</body>
</html>
