{% extends 'base.html' %}

{% block content %}
<h1 class="text-2xl font-bold mb-4">Portfolios</h1>
<form method="post" action="{{ url_for('create_portfolio') }}" class="mb-4 space-x-2">
    <input type="text" name="name" placeholder="Name" required class="border px-1 py-0" />
    <select name="strategy_type" class="border rounded px-1 py-0">
        {% for s in ['default', 'momentum', 'mean_reversion'] %}
        <option value="{{ s }}">{{ s }}</option>
        {% endfor %}
    </select>
    <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-1 px-3 rounded">Add</button>
</form>
<form method="post" action="{{ url_for('step') }}" class="mb-4">
    <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Step</button>
</form>
<div class="space-y-4">
    {% for p in portfolios %}
    <div id="portfolio-{{ p.name }}" class="bg-white shadow p-4 rounded">
        <div class="flex justify-between items-center">
            <h2 class="text-xl font-semibold">{{ p.name }}</h2>
            <form method="post" action="{{ url_for('delete_portfolio', name=p.name) }}">
                <button type="submit" class="text-red-500 text-sm">Delete</button>
            </form>
        </div>
        <form method="post" action="{{ url_for('set_strategy', name=p.name) }}" class="my-2">
            <label class="text-sm">Strategy:
                <select name="strategy_type" onchange="this.form.submit()" class="border rounded px-1 py-0">
                    {% for s in ['default', 'momentum', 'mean_reversion'] %}
                        <option value="{{ s }}" {% if p.strategy_type == s %}selected{% endif %}>{{ s }}</option>
                    {% endfor %}
                </select>
            </label>
        </form>
        <form method="post" action="{{ url_for('set_prompt', name=p.name) }}" class="my-2">
            <label class="text-sm font-semibold">Custom Prompt:</label>
            <textarea name="custom_prompt" rows="3" class="border rounded w-full">{{ p.custom_prompt }}</textarea>
            <div class="flex items-center space-x-2 mt-1">
                <button type="submit" class="bg-purple-500 hover:bg-purple-700 text-white text-xs px-2 py-1 rounded">Save</button>
                <button type="button" onclick="previewPrompt('{{ p.name }}')" class="bg-gray-300 text-xs px-2 py-1 rounded">Preview</button>
                <span id="preview-{{ p.name }}" class="text-xs"></span>
            </div>
        </form>
        <p>Cash: <span class="cash">{{ p.cash }}</span></p>
        <p>Portfolio value: <span class="portfolio_value">{{ p.portfolio_value }}</span></p>
        <div class="h-48">
            <canvas id="chart-{{ p.name }}"></canvas>
        </div>
        <p class="mt-2">Diversification score: <span class="divscore">{{ p.diversification_score }}</span></p>
        <div class="mt-2">
            <table class="text-xs border" id="corr-{{ p.name }}">
                <tbody>
                    {% for row_sym, cols in p.correlation.items() %}
                    <tr>
                        <th class="border px-1">{{ row_sym }}</th>
                        {% for col_sym, val in cols.items() %}
                        <td class="border px-1">{{ '%.2f' % val }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="h-32 mt-2">
            <canvas id="alloc-chart-{{ p.name }}"></canvas>
        </div>
        <h3 class="font-semibold mt-2">Risk Alerts</h3>
        <ul class="list-disc list-inside risk_alerts">
            {% for alert in p.risk_alerts %}
            <li>{{ alert }}</li>
            {% else %}
            <li>No alerts.</li>
            {% endfor %}
        </ul>
        <div class="mt-2">
            <h3 class="font-semibold">Positions</h3>
            <div class="flex space-x-2 mb-1 text-sm">
                <input type="text" placeholder="Filter" id="pos-filter-{{ p.name }}" class="border px-1 py-0">
                <select id="pos-sort-{{ p.name }}" class="border px-1 py-0">
                    <option value="symbol">Symbol</option>
                    <option value="pnl">PnL</option>
                </select>
            </div>
            <table class="text-xs border w-full" id="positions-{{ p.name }}">
                <thead>
                    <tr>
                        <th class="border px-1">Symbol</th>
                        <th class="border px-1">Qty</th>
                        <th class="border px-1">Price</th>
                        <th class="border px-1">Avg</th>
                        <th class="border px-1">PnL</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="mt-2">
            <h3 class="font-semibold">Open Orders</h3>
            <table class="text-xs border w-full" id="orders-{{ p.name }}">
                <thead>
                    <tr>
                        <th class="border px-1">Status</th>
                        <th class="border px-1">Type</th>
                        <th class="border px-1">Symbol</th>
                        <th class="border px-1">Qty</th>
                        <th class="border px-1">Limit</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="mt-2">
            <div class="flex items-center space-x-2 text-xs mb-1">
                <label>PnL Interval
                    <select id="pnl-interval-{{ p.name }}" class="border px-1 py-0">
                        <option value="day">day</option>
                        <option value="week">week</option>
                        <option value="month">month</option>
                    </select>
                </label>
            </div>
            <div class="h-24">
                <canvas id="pnl-chart-{{ p.name }}"></canvas>
            </div>
            <div class="h-24 mt-1">
                <canvas id="pnl-bar-{{ p.name }}"></canvas>
            </div>
        </div>
        <div class="flex items-center justify-between mt-2">
            <h3 class="font-semibold">Trades</h3>
            <div class="space-x-2 text-sm">
                <a href="{{ url_for('export_trades', name=p.name) }}" class="text-blue-500">Download</a>
                <a href="{{ url_for('get_report', name=p.name) }}" class="text-blue-500">Report</a>
            </div>
        </div>
        <div class="h-24 mt-1">
            <canvas id="trade-chart-{{ p.name }}"></canvas>
        </div>
        <p id="trade-summary-{{ p.name }}" class="text-xs mt-1"></p>
        <ul class="list-disc list-inside history cursor-pointer"></ul>
        <pre id="trade-details-{{ p.name }}" class="text-xs bg-gray-100 mt-1"></pre>
        <div class="h-32 mt-1">
            <canvas id="trade-price-{{ p.name }}"></canvas>
        </div>
    </div>
    {% endfor %}
</div>
<script id="initial-data" type="application/json">{{ portfolios | tojson }}</script>
{% endblock %}
