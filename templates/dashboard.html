{% extends 'base.html' %}

{% block content %}
<h1 class="text-2xl font-bold mb-4">Portfolios</h1>
<form method="post" action="{{ url_for('create_portfolio') }}" class="mb-4 space-x-2">
    <input type="text" name="name" placeholder="Name" required class="border px-1 py-0" />
    <select name="strategy_type" class="border rounded px-1 py-0">
        {% for s in ['default', 'momentum', 'mean_reversion'] %}
        <option value="{{ s }}">{{ s }}</option>
        {% endfor %}
    </select>
    <input type="text" name="prompt" placeholder="Custom prompt" class="border px-1 py-0" />
    <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-1 px-3 rounded">Add</button>
</form>
<form method="post" action="{{ url_for('step') }}" class="mb-4">
    <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Step</button>
</form>
<div class="space-y-4">
    {% for p in portfolios %}
    <div id="portfolio-{{ p.name }}" class="bg-white shadow p-4 rounded">
        <div class="flex justify-between items-center">
            <h2 class="text-xl font-semibold">{{ p.name }}</h2>
            <form method="post" action="{{ url_for('delete_portfolio', name=p.name) }}">
                <button type="submit" class="text-red-500 text-sm">Delete</button>
            </form>
        </div>
        <form method="post" action="{{ url_for('set_strategy', name=p.name) }}" class="my-2">
            <label class="text-sm">Strategy:
                <select name="strategy_type" onchange="this.form.submit()" class="border rounded px-1 py-0">
                    {% for s in ['default', 'momentum', 'mean_reversion'] %}
                        <option value="{{ s }}" {% if p.strategy_type == s %}selected{% endif %}>{{ s }}</option>
                    {% endfor %}
                </select>
            </label>
        </form>
        <form method="post" action="{{ url_for('set_prompt', name=p.name) }}" class="my-2">
            <textarea name="prompt" rows="2" class="border rounded w-full" placeholder="Custom prompt">{{ p.custom_prompt }}</textarea>
            <button type="submit" class="bg-gray-300 text-sm px-2 py-0.5 rounded mt-1">Save Prompt</button>
        </form>
        <p>Cash: <span class="cash">{{ p.cash }}</span></p>
        <p>Portfolio value: <span class="portfolio_value">{{ p.portfolio_value }}</span></p>
        <div class="h-48">
            <canvas id="chart-{{ p.name }}"></canvas>
        </div>
        <p class="mt-2">Diversification score: <span class="divscore">{{ p.diversification_score }}</span></p>
        <div class="mt-2">
            <table class="text-xs border" id="corr-{{ p.name }}">
                <tbody>
                    {% for row_sym, cols in p.correlation.items() %}
                    <tr>
                        <th class="border px-1">{{ row_sym }}</th>
                        {% for col_sym, val in cols.items() %}
                        <td class="border px-1">{{ '%.2f' % val }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <h3 class="font-semibold mt-2">Risk Alerts</h3>
        <ul class="list-disc list-inside risk_alerts">
            {% for alert in p.risk_alerts %}
            <li>{{ alert }}</li>
            {% else %}
            <li>No alerts.</li>
            {% endfor %}
        </ul>
        <div class="flex items-center justify-between mt-2">
            <h3 class="font-semibold">Trades</h3>
            <div class="space-x-2 text-sm">
                <a href="{{ url_for('export_trades', name=p.name) }}" class="text-blue-500">Download</a>
                <a href="{{ url_for('get_report', name=p.name) }}" class="text-blue-500">Report</a>
            </div>
        </div>
        <ul class="list-disc list-inside history">
            {% for trade in p.history %}
            <li>{{ trade.get('symbol') }} {{ trade.get('side') }} {{ trade.get('qty') }} @ {{ trade.get('submitted_at') }}</li>
            {% else %}
            <li>No trades yet.</li>
            {% endfor %}
        </ul>
    </div>
    {% endfor %}
</div>
<script id="initial-data" type="application/json">{{ portfolios | tojson }}</script>
{% endblock %}
